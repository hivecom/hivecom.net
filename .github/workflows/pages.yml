# https://github.com/actions/deploy-pages#usage
name: Deploy to GitHub pages
on:
  workflow_run:
    workflows: [Push Supabase]
    types:
      - completed
    branches:
      - main

  # Or trigger manually
  workflow_dispatch:

jobs:
  build:
    # Only allow manual runs or successful Supabase runs from main
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest

    environment: github_pages
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      NUXT_PUBLIC_SUPABASE_PROJECT_REF: ${{ vars.NUXT_PUBLIC_SUPABASE_PROJECT_REF }}
      NUXT_PUBLIC_PATREON_CLIENT_ID: ${{ vars.NUXT_PUBLIC_PATREON_CLIENT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main # Always build from the main branch

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Lint code
        run: npm run lint

      - name: Nuxt build with nitro for GitHub pages
        run: npm run build

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./.output/public

  deploy:
    needs: build # Add a dependency to the build job

    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write # to deploy to Pages
      id-token: write # to verify the deployment originates from an appropriate source

    # Deploy to the github_pages environment
    environment:
      name: github_pages
      url: ${{ steps.deployment.outputs.page_url }}

    # Specify runner + deployment step
    runs-on: ubuntu-latest
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
